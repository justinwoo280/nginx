name: Build nginx with AWS-LC

on:
  push:
    branches:
      - master
      - 'stable-*'
  pull_request:
    branches:
      - master

jobs:
  build:
    name: nginx + AWS-LC (full)
    runs-on: ubuntu-24.04

    steps:
      - name: Checkout nginx
        uses: actions/checkout@v4

      - name: Install build dependencies
        run: |
          sudo apt-get update -qq
          sudo apt-get install -y --no-install-recommends \
            build-essential \
            cmake \
            ninja-build \
            golang-go \
            libpcre2-dev \
            zlib1g-dev \
            libxslt1-dev \
            libxml2-dev \
            libgd-dev \
            libgeoip-dev \
            libperl-dev

      - name: Resolve AWS-LC HEAD commit
        id: awslc-rev
        run: |
          SHA=$(git ls-remote https://github.com/aws/aws-lc refs/heads/main | cut -f1)
          echo "sha=${SHA}" >> "$GITHUB_OUTPUT"
          echo "AWS-LC HEAD: ${SHA}"

      - name: Cache AWS-LC
        id: cache-awslc
        uses: actions/cache@v4
        with:
          path: ${{ github.workspace }}/aws-lc
          key: awslc-${{ runner.os }}-${{ steps.awslc-rev.outputs.sha }}

      - name: Fetch AWS-LC
        if: steps.cache-awslc.outputs.cache-hit != 'true'
        run: |
          mkdir aws-lc && cd aws-lc
          git init
          git remote add origin https://github.com/aws/aws-lc
          git fetch --depth=1 origin ${{ steps.awslc-rev.outputs.sha }}
          git checkout FETCH_HEAD

      - name: Build AWS-LC (static only)
        if: steps.cache-awslc.outputs.cache-hit != 'true'
        run: |
          cmake -GNinja \
            -DCMAKE_BUILD_TYPE=Release \
            -DBUILD_SHARED_LIBS=OFF \
            -DBUILD_TESTING=OFF \
            -DDISABLE_PERL=ON \
            -DCMAKE_C_FLAGS="-fPIC" \
            -DCMAKE_CXX_FLAGS="-fPIC" \
            -B aws-lc/build \
            aws-lc
          ninja -C aws-lc/build ssl crypto

      - name: Prepare AWS-LC .openssl structure for nginx
        run: |
          LIBSSL=$(find aws-lc/build -name "libssl.a" | head -1)
          LIBCRYPTO=$(find aws-lc/build -name "libcrypto.a" | head -1)
          if [ -z "$LIBSSL" ] || [ -z "$LIBCRYPTO" ]; then
            echo "ERROR: could not find libssl.a or libcrypto.a under aws-lc/build"
            find aws-lc/build -name "*.a" | sort
            exit 1
          fi
          echo "Found: $LIBSSL"
          echo "Found: $LIBCRYPTO"
          rm -rf aws-lc/.openssl
          mkdir -p aws-lc/.openssl/lib
          cp "$LIBSSL"   aws-lc/.openssl/lib/
          cp "$LIBCRYPTO" aws-lc/.openssl/lib/
          ln -sf ${{ github.workspace }}/aws-lc/include aws-lc/.openssl/include
          ls -lh aws-lc/.openssl/lib/
          ls -lh aws-lc/.openssl/include

      - name: Patch nginx openssl conf for C++ runtime linkage ordering
        run: |
          sed -i '/CORE_LIBS=.*libcrypto\.a/a\            CORE_LIBS="$CORE_LIBS -Wl,-Bstatic,-lstdc++,-Bdynamic"' auto/lib/openssl/conf

      - name: Configure nginx
        run: |
          auto/configure \
            --prefix=/etc/nginx \
            --sbin-path=/usr/sbin/nginx \
            --modules-path=/usr/lib/nginx/modules \
            --conf-path=/etc/nginx/nginx.conf \
            --error-log-path=/var/log/nginx/error.log \
            --http-log-path=/var/log/nginx/access.log \
            --pid-path=/var/run/nginx.pid \
            --lock-path=/var/run/nginx.lock \
            --http-client-body-temp-path=/var/cache/nginx/client_temp \
            --http-proxy-temp-path=/var/cache/nginx/proxy_temp \
            --http-fastcgi-temp-path=/var/cache/nginx/fastcgi_temp \
            --http-uwsgi-temp-path=/var/cache/nginx/uwsgi_temp \
            --http-scgi-temp-path=/var/cache/nginx/scgi_temp \
            --with-threads \
            --with-file-aio \
            --with-http_ssl_module \
            --with-http_v2_module \
            --with-http_v3_module \
            --with-http_realip_module \
            --with-http_addition_module \
            --with-http_xslt_module \
            --with-http_image_filter_module \
            --with-http_geoip_module \
            --with-http_sub_module \
            --with-http_dav_module \
            --with-http_flv_module \
            --with-http_mp4_module \
            --with-http_gunzip_module \
            --with-http_gzip_static_module \
            --with-http_auth_request_module \
            --with-http_random_index_module \
            --with-http_secure_link_module \
            --with-http_slice_module \
            --with-http_stub_status_module \
            --with-http_perl_module \
            --with-mail \
            --with-mail_ssl_module \
            --with-stream \
            --with-stream_ssl_module \
            --with-stream_realip_module \
            --with-stream_geoip_module \
            --with-stream_ssl_preread_module \
            --with-pcre-jit \
            --with-openssl=${{ github.workspace }}/aws-lc \
            --with-cc-opt="-O2 -fstack-protector-strong -Wno-deprecated-declarations" \
            --with-ld-opt="-Wl,-z,relro -Wl,-z,now"
          touch ${{ github.workspace }}/aws-lc/.openssl/include/openssl/ssl.h

      - name: Build nginx
        run: make -j$(nproc)

      - name: Verify binary - no dynamic ssl/crypto linkage
        run: |
          echo "=== Dynamic dependencies ==="
          ldd ./objs/nginx
          echo ""
          echo "=== Checking for dynamic ssl/crypto (should be empty) ==="
          ldd ./objs/nginx | grep -E "libssl|libcrypto" && \
            { echo "ERROR: dynamic ssl/crypto linkage found!"; exit 1; } || \
            echo "OK: no dynamic ssl/crypto linkage"

      - name: Verify binary - nginx version and SSL backend
        run: |
          echo "=== nginx -V ==="
          ./objs/nginx -V 2>&1
          echo ""
          echo "=== Checking SSL backend is AWS-LC ==="
          ./objs/nginx -V 2>&1 | grep -i "aws-lc\|AWS-LC" && \
            echo "OK: AWS-LC confirmed" || \
            { echo "WARNING: AWS-LC string not found in version output"; ./objs/nginx -V 2>&1; }

      - name: Verify binary - QUIC support compiled in
        run: |
          ./objs/nginx -V 2>&1 | grep -i "http_v3_module\|quic" && \
            echo "OK: HTTP/3 (QUIC) module present" || \
            { echo "ERROR: HTTP/3 module not found"; exit 1; }

      - name: Upload nginx binary
        uses: actions/upload-artifact@v4
        with:
          name: nginx-awslc-${{ github.sha }}
          path: objs/nginx
          retention-days: 14
